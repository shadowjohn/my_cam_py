import cv2
import numpy as np
import time
import tkinter as tk
from tkinter import ttk
from tkinter import messagebox
from tkinter import filedialog
from tkinter import Label, Tk, StringVar
import threading
import os
import webbrowser
import sounddevice as sd
import soundfile as sf
from moviepy.editor import VideoFileClip, AudioFileClip
from pydub import AudioSegment
import sys
import base64
import portalocker
import mss

#進度條
from proglog import ProgressBarLogger

pwd = os.path.dirname(os.path.realpath(sys.argv[0])) # 取得 exe 檔案的目錄路徑
output_path = pwd + "\\output"
GDATA = {
    "VERSION":"0.01",
    "UI": {
        "fps_selected": None
    },
    "THREAD":{
    },
    "pwd":pwd,
    "output_path":output_path,
    "video_file":output_path + "\\output.mp4",
    "audio_mic_file":output_path + "\\output_mic.wav",
    "audio_system_file":output_path + "\\output_system.wav",
    "output_file":output_path + "\\final_output.mp4",
    "recording":False, # 錄製狀態
    "out":None,
    "record_area": None,
    "x1": 0,
    "xy": 0,
    "x2": 0,
    "y2": 0,
    "rect": None,
    "frame_list": [], # 幀列表
    "run_start_time": None, # 影片開始轉檔時間
    "run_end_time": None, # 影片結束轉檔時間
}

lock_file = pwd + "\\lock.txt"

# 檢查是否存在鎖定檔案並創建文件鎖
# 防程式重複啟動
check_file_run = open(lock_file, "a+")
try:
    portalocker.lock(check_file_run, portalocker.LOCK_EX | portalocker.LOCK_NB)
except:
    messagebox.showinfo("說明", "程式已執行了...")
    sys.exit()


MESSAGE = f"""
桌面錄影小工具

版本: {GDATA["VERSION"]}
作者: 羽山 (https://3wa.tw)  
    
"""
icon_b64 = "AAABAAEAWFgAAAEAIABIfQAAFgAAACgAAABYAAAAsAAAAAEAIAAAAAAAAHkAAMMOAADDDgAAAAAAAAAAAAD/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////v+Ow/5zUhf+c1IX/nNSF/6zbmf+/47D/6PXi/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+j14v///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////4zNcf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/rNuZ//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9nvUP/Z71D/33GXv+c1IX/td+k/9fuzf////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+MzXH////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////X7s3/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/Z71D/33GXv+c1IX/td+k/9fuzf/////////////////////////////////////////////////////////////////////////////////////////////////////////////////X7s3/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/7/jsP/////////////////////////////////////////////////X7s3/yui9////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////td+k/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/Z71D/33GXv+c1IX/v+Ow/+j14v///////////////////////////////////////////4XKaP+Fymj/6PXi////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+Fymj//////////////////////////////////////+j14v+U0Hv/X7k5/3XCVP///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L/4XKaP+c1IX/v+Ow/////////////////7/jsP9fuTn/X7k5/2e9Q/+136T//////////////////////26/S/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////////////////////8rovf91wlT/X7k5/1+5Of9fuTn/pNeO//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/dcJU/4zNcf9uv0v/X7k5/1+5Of9fuTn/X7k5/4zNcf/o9eL//////7XfpP99xl7/fcZe/33GXv99xl7/Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of///////////////////////////7XfpP9nvUP/X7k5/1+5Of9fuTn/X7k5/2e9Q//K6L3/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L/7/jsP///////////////////////////7XfpP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn//////////////////////6zbmf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L/+j14v//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////6PXi/3XCVP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/lNB7//////////////////////+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/////////////////6zbmf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/6PXi/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9fuzf+/47D/nNSF/4zNcf99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/yui9////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of///////////8rovf9nvUP/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/Z71D/6zbmf/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////o9eL/dcJU/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+k147//////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn//////+j14v9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9nvUP/nNSF/+j14v///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/26/S/+c1IX/hcpo/26/S/9fuTn/X7k5/1+5Of9fuTn/X7k5/+j14v+c1IX/Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv+136T/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5//////+Fymj/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/1+7N//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+Fymj/lNB7/7XfpP////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/////////////////6PXi/7/jsP+c1IX/jM1x/3XCVP///////////9fuzf99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+136T/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////X7k5/1+5Of9fuTn/X7k5/4XKaP/X7s3/fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////8rovf+k147/yui9/////////////////////////////////7XfpP9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/26/S/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////1+5Of9fuTn/X7k5/1+5Of9fuTn/yui9/33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv+/47D/jM1x/2e9Q/9fuTn/X7k5/5TQe///////////////////////////////////////6PXi/5TQe/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5//////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/yui9/1+5Of9fuTn/X7k5/1+5Of91wlT/////////////////////////////////////////////////yui9/3XCVP9fuTn/X7k5/1+5Of9uv0v/v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+136T/X7k5/1+5Of9fuTn/X7k5/26/S///////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe//////9nvUP/X7k5/1+5Of9fuTn/X7k5/9fuzf//////////////////////////////////////////////////////pNeO/2e9Q/9fuTn/pNeO/7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+MzXH/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of+Fymj//////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv//////jM1x/1+5Of9fuTn/X7k5/1+5Of+k147//////////////////////////////////////7/jsP/o9eL////////////o9eL/hcpo/+j14v+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/6PXi/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////4XKaP9fuTn/X7k5/1+5Of9fuTn/nNSF//////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7//////6TXjv9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////////////////////+j14v9nvUP/br9L/7/jsP//////////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/v+Ow/9fuzf+MzXH/lNB7//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9nvUP/X7k5/1+5Of9fuTn/X7k5/7/jsP//////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe///////K6L3/X7k5/1+5Of9fuTn/X7k5/1+5Of/o9eL///////////////////////////+c1IX/X7k5/1+5Of9fuTn/hcpo/+j14v///////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/hcpo/5zUhf9fuTn/X7k5/1+5Of+s25n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////X7s3/X7k5/1+5Of9fuTn/X7k5/1+5Of/o9eL//////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv///////////1+5Of9fuTn/X7k5/1+5Of9fuTn/td+k///////////////////////o9eL/Z71D/1+5Of9fuTn/X7k5/1+5Of9nvUP/rNuZ//////+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/8rovf//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////rNuZ/1+5Of9fuTn/X7k5/1+5Of91wlT///////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7///////////99xl7/X7k5/1+5Of9fuTn/X7k5/4zNcf//////////////////////hcpo/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/4zNcf//////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/5TQe/9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9nvUP/6PXi/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////4zNcf9fuTn/X7k5/1+5Of9fuTn/lNB7////////////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe////////////lNB7/1+5Of9fuTn/X7k5/1+5Of9uv0v/////////////////td+k/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of/X7s3//////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of/o9eL/v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+136T/jM1x/26/S/9fuTn/X7k5/7XfpP///////////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv///////////5zUhf9fuTn/X7k5/1+5Of9fuTn/br9L/9fuzf//////1+7N/2e9Q/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX///////////+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+MzXH///////////+U0Hv/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/nNSF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////1+7N/6zbmf/o9eL///////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7///////////+/47D/dcJU/5TQe/+136T/6PXi////////////6PXi/3XCVP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/v+Ow////////////6PXi/2e9Q/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+136T/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////////////////////////////////////4XKaP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9nvUP/yui9/////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L//////////////////////+s25n/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/Z71D/9fuzf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv///////////////////////////////////////////+j14v+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/td+k//////////////////////+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/5TQe////////////////////////////3XCVP9fuTn/X7k5/1+5Of9fuTn/X7k5/26/S/+/47D///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv///////////9fuzf+Fymj/X7k5/1+5Of9fuTn/rNuZ////////////////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of/K6L3///////////////////////////+/47D/X7k5/1+5Of9fuTn/br9L/6zbmf//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7//////////////////////7/jsP9uv0v/rNuZ/////////////////////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn//////////////////////////////////////33GXv99xl7/v+Ow/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe//////////////////////////////////////////////////////////////////////+/47D/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5///////////////////////////////////////o9eL///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv+/47D/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/jM1x/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/v+Ow////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/5zUhf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////X7s3/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/v+Ow/7/jsP91wlT/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/v+Ow/8rovf+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/nNSF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe////////////////////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/5zUhf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv///////////////////////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7///////////////////////////////////////////+/47D/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/26/S/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of91wlT/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/v+Ow////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////fcZe/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of///////////////////////////////////////////9fuzf+/47D/v+Ow/6zbmf//////////////////////////////////////////////////////pNeO/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/26/S////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+j14v+c1IX/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn//////////////////////8rovf91wlT/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/6PXi/////////////////////////////////////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8rovf9nvUP/hcpo/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5///////////////////////o9eL/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/4zNcf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+c1IX/nNSF/5zUhf+MzXH/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/8rovf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+j14v9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of///////////////////////////3XCVP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+/47D///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn///////////////////////////+U0Hv/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/nNSF/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+j14v+MzXH/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5////////////////////////////td+k/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/5TQe/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////91wlT/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+136T/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/dcJU/2e9Q//o9eL//////////////////////+j14v9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////v+Ow/2e9Q/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/dcJU/+j14v//////////////////////////////////////////////////////rNuZ/1+5Of9fuTn/dcJU////////////////////////////br9L/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/dcJU///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////K6L3/Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+MzXH/////////////////////////////////////////////////1+7N/2e9Q/9fuTn/X7k5/1+5Of+MzXH//////////////////////4zNcf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+Fymj/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/v+Ow/7/jsP+/47D/pNeO/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8rovf9nvUP/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/6zbmf//////////////////////////////////////6PXi/3XCVP9fuTn/X7k5/1+5Of9fuTn/X7k5/6TXjv////////////////+k147/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/////////////////////////////////////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/1+7N////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yui9/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9nvUP/1+7N/////////////////////////////////4zNcf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/td+k////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of//////////////////////////////////////////////////////X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/7/jsP////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+s25n/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/3XCVP///////////////////////////5zUhf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/4XKaP////////////////9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/yui9/////////////////////////////////////////////////1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5TQe/9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/nNSF/////////////////6zbmf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/2e9Q//o9eL/////////////////dcJU/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/3XCVP99xl7/fcZe/33GXv99xl7/fcZe/33GXv99xl7/fcZe/33GXv9nvUP/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/nNSF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////dcJU/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/2e9Q//X7s3//////6zbmf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of/K6L3//////////////////////4zNcf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/4zNcf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9fuzf9nvUP/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/fcZe/6zbmf9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n///////////////////////////+k147/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of99xl7/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////nNSF/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n/////////////////////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/br9L//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9uv0v/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n//////////////////////////////////////+j14v9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n/////////////////////////////////////////////////Z71D/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/33GXv99xl7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+s25n//////////////////////////////////////////////////////33GXv9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of+c1IX//////////////////////////////////////////////////////8rovf/K6L3/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////v+Ow/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/2e9Q/+s25n///////////////////////////////////////////////////////////+U0Hv/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/hcpo//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////99xl7/X7k5/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/2e9Q//K6L3/////////////////////////////////////////////////////////////////pNeO/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/3XCVP//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////rNuZ/1+5Of9fuTn/X7k5/1+5Of9fuTn/X7k5/3XCVP/X7s3//////////////////////////////////////////////////////////////////////7/jsP9fuTn/X7k5/1+5Of9fuTn/fcZe/33GXv99xl7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+/47D/v+Ow/7/jsP+/47D/v+Ow/7/jsP/o9eL////////////////////////////////////////////////////////////////////////////o9eL/yui9////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"




if os.path.isdir(GDATA["output_path"]) == False:
    # 建目錄
    os.mkdir(GDATA["output_path"])





def select_area():
    global GDATA
    GDATA["record_area"] = tk.Toplevel()
    GDATA["record_area"].attributes("-fullscreen", True)
    GDATA["record_area"].attributes("-alpha", 0.3)
    GDATA["record_area"].configure(background="black")

    instruction = tk.Label(GDATA["record_area"], text="用滑鼠框選錄影範圍", bg="white")
    instruction.pack()

    canvas = tk.Canvas(GDATA["record_area"], cursor="cross")
    canvas.pack(fill="both", expand=True)
    
    GDATA["rect"] = None

    def on_button_press(event):
        global GDATA
        GDATA["x1"], GDATA["y1"] = event.x, event.y
        GDATA["rect"] = canvas.create_rectangle(
            event.x, event.y, event.x, event.y, outline="red"
        )

    def on_move_press(event):
        global GDATA
        GDATA["x2"], GDATA["y2"] = event.x, event.y
        canvas.coords(GDATA["rect"], GDATA["x1"], GDATA["y1"], GDATA["x2"], GDATA["y2"])

    def on_button_release(event):
        GDATA["record_area"].grab_release()  # 釋放滑鼠事件
        GDATA["record_area"].destroy()

    canvas.bind("<ButtonPress-1>", on_button_press)
    canvas.bind("<B1-Motion>", on_move_press)
    canvas.bind("<ButtonRelease-1>", on_button_release)

    GDATA["record_area"].grab_set_global()  # 捕獲滑鼠事件


def start_recording():            
    global GDATA
    # Lock UI
    ui_enable_disable(False)

    t = str(int(time.time()))
    GDATA["video_file"] = GDATA["output_path"] + "\\" + t + "_tmp.mp4"
    GDATA["audio_mic_file"] = GDATA["output_path"] + "\\" + t + "_mic_tmp.wav"
    GDATA["audio_system_file"] = GDATA["output_path"] + "\\" + t + "_system_tmp.wav"
    GDATA["output_file"] = GDATA["output_path"] + "\\" + t + ".mp4"

    print("x1, y1: %s, %s" % (GDATA["x1"], GDATA["y1"]))
    print("x2, y2: %s, %s" % (GDATA["x2"], GDATA["y2"]))           
    if GDATA["recording"]:
        messagebox.showwarning("警告", "錄影已經在進行中！")
        return
    if GDATA["x1"] == GDATA["x2"] or GDATA["y1"] == GDATA["y2"]:
        messagebox.showwarning("警告", "請先選擇錄影範圍！")
        return
    GDATA["UI"]["progress_label"].config(text="影像截取中...")
    GDATA["recording"] = True      
    
    GDATA["fps"] = float(GDATA["UI"]["fps_selected"].get())
    w = GDATA["x2"] - GDATA["x1"]
    h = GDATA["y2"] - GDATA["y1"]
    #GDATA["out"] = cv2.VideoWriter(GDATA["video_file"], cv2.VideoWriter_fourcc(*"MP4V"), GDATA["fps"], (w, h))    
    GDATA["frame_list"] = []
    GDATA["THREAD"]["video_thread"] = threading.Thread(target=record_video)
    GDATA["THREAD"]["process_thread"] = threading.Thread(target=process_frames)
    
    # 看是否要錄聲音
    if GDATA["UI"]["record_system_sound"].get() == True:
        GDATA["THREAD"]["audio_system_thread"] = threading.Thread(target=record_system_audio)
    if GDATA["UI"]["record_mic_sound"].get() == True:
        GDATA["THREAD"]["audio_mic_thread"] = threading.Thread(target=record_mic_audio)    
    if GDATA["UI"]["record_system_sound"].get() == True:
        GDATA["THREAD"]["audio_system_thread"].start()
    if GDATA["UI"]["record_mic_sound"].get() == True:
        GDATA["THREAD"]["audio_mic_thread"].start()
    
    GDATA["THREAD"]["video_thread"].start()
    GDATA["THREAD"]["process_thread"].start()
        
    GDATA["UI"]["start_button"].config(state=tk.DISABLED)
    GDATA["UI"]["stop_button"].config(state=tk.NORMAL)

def ui_enable_disable(bool_val):
    global GDATA        
    if bool_val == True:
        GDATA["UI"]["checkbox_system_sound"].config(state=tk.NORMAL)
        GDATA["UI"]["checkbox_microphone"].config(state=tk.NORMAL)
        GDATA["UI"]["fps_menu"].config(state=tk.NORMAL)
        GDATA["UI"]["checkbox_mouse_cursor"].config(state=tk.NORMAL)
        GDATA["UI"]["select_area_button"].config(state=tk.NORMAL)
        GDATA["UI"]["compression_level_selected_menu"].config(state=tk.NORMAL)
        GDATA["UI"]["exit_button"].config(state=tk.NORMAL)
    else:
        GDATA["UI"]["checkbox_system_sound"].config(state=tk.DISABLED)
        GDATA["UI"]["checkbox_microphone"].config(state=tk.DISABLED)
        GDATA["UI"]["fps_menu"].config(state=tk.DISABLED)
        GDATA["UI"]["checkbox_mouse_cursor"].config(state=tk.DISABLED)
        GDATA["UI"]["select_area_button"].config(state=tk.DISABLED)
        GDATA["UI"]["compression_level_selected_menu"].config(state=tk.DISABLED)
        GDATA["UI"]["exit_button"].config(state=tk.DISABLED)
        
def process_frames():
    global GDATA
    w = GDATA["x2"] - GDATA["x1"]
    h = GDATA["y2"] - GDATA["y1"]
    GDATA["out"] = cv2.VideoWriter(GDATA["video_file"], cv2.VideoWriter_fourcc(*"MP4V"), GDATA["fps"], (w, h))    
    last_frame_time = None

    # 每一幀間隔時間
    frame_step_time = 1 / GDATA["fps"]

    while GDATA["recording"] or len(GDATA["frame_list"]) > 0:
        if len(GDATA["frame_list"]) > 0:
            current_frame_data = GDATA["frame_list"].pop(0)
            current_time = current_frame_data["timestamp"]
            current_frame = current_frame_data["frame"]

            if last_frame_time is None:
                # 第一幀
                last_frame_time = current_time
                frame_rgb = cv2.cvtColor(np.array(current_frame), cv2.COLOR_RGBA2RGB)
                GDATA["out"].write(frame_rgb)
            else:
                # 計算時間差
                time_diff = current_time - last_frame_time
                if time_diff < frame_step_time:
                    # 超速了 這張多截的，不要
                    continue
                else:
                    # 按照時間差計算需要插入的幀數
                    # 用 int 取代 math.floor
                    frame_times = int(time_diff / frame_step_time)
                    for _ in range(frame_times):
                        frame_rgb = cv2.cvtColor(np.array(current_frame), cv2.COLOR_RGBA2RGB)
                        GDATA["out"].write(frame_rgb)
                    last_frame_time += frame_times * frame_step_time  # 更新最後一幀的時間
        time.sleep(0.001)  # 避免空循環佔用太多 CPU

    GDATA["out"].release()    
    cv2.destroyAllWindows()
def record_video():
    global GDATA
    w = GDATA["x2"] - GDATA["x1"]
    h = GDATA["y2"] - GDATA["y1"]
    # 設置屏幕捕獲
    monitor = {"top": GDATA["y1"], "left": GDATA["x1"], "width": w, "height": h}
    # 幀時間間隔
    frame_time = 1 / GDATA["fps"]
    is_need_cursor = GDATA["UI"]["record_mouse"].get()
    
    # 畫質
    _compression_level = GDATA["UI"]["compression_level_selected"].get()
    
    GDATA["frame_count"] = 0
    GDATA["run_start_time"] = time.time()
    GDATA["start_time"] = time.time()
    update_fps_label()
    sct = mss.mss(compression_level=_compression_level,with_cursor=is_need_cursor)
    while GDATA["recording"]:
        #if is_need_cursor == True:
        #    # 這樣才會一直更新滑鼠位置
        #    # 後來直接改 mss/windows.py #328 與 #329 #367 的地方
        #    # mss/base.py #240~#243 回收 ram
        #    # 一直重新宣告 sct 造成記憶體肥大 crash
        #    sct = mss.mss(compression_level=_compression_level,with_cursor=is_need_cursor)
        # 記錄當前時間
        GDATA["frame_count"] += 1
        ct = time.time()
        elapsed_time = ct - GDATA["start_time"]

        # 截取指定區域的圖像
        try:
            GDATA["frame_list"].append({"timestamp":ct, "frame":sct.grab(monitor)})
        except:
            pass
        if elapsed_time >= 1.0:
            current_fps = GDATA["frame_count"] / elapsed_time                
            GDATA["frame_count"] = 0
            GDATA["start_time"] = time.time()        

    #out.release()
    #cv2.destroyAllWindows()


def record_mic_audio():
    global GDATA    
    samplerate = 44100
    channels = 2
    # 開啟音訊檔案準備寫入
    with sf.SoundFile(GDATA["audio_mic_file"], mode="x", samplerate=samplerate, channels=channels) as file:
        keywords = ["麥克風", "USB PnP Sound Device", "Realtek HD Audio Mic input"]

        # 查找第一組匹配的設備
        device_index, device_name = find_device_by_name(keywords)
        if device_index == None:
            device_index = 0
        with sd.InputStream(samplerate=samplerate, channels=channels, device=device_index) as stream:
            print("錄製麥克風聲音開始...")
            while GDATA["recording"]:
                data, overflowed = stream.read(1024)
                file.write(data)
            print("錄製麥克風聲音結束.")


print(sd.query_devices())


def record_system_audio():
    global GDATA
    samplerate = 44100
    channels = 2

    # 開啟音訊檔案準備寫入
    with sf.SoundFile(GDATA["audio_system_file"], mode="x", samplerate=samplerate, channels=channels) as file_system:
        # 使用 OutputStream 寫入系統聲音
        # 要查找的關鍵字，包括中文和英文名稱的一部分
        keywords = ["立體聲混音", "Stereo Mix"]

        # 查找第一組匹配的設備
        device_index, device_name = find_device_by_name(keywords)
        if device_index == None:
            device_index = 0
        print("使用音源: %s" % (device_index))
        with sd.InputStream(samplerate=samplerate, channels=channels, device=device_index) as sys_stream:
            print("錄製系統聲音開始...")
            while GDATA["recording"]:
                data, overflowed = sys_stream.read(1024)
                file_system.write(data)
            print("錄製系統聲音結束.")


def stop_recording():
    global GDATA
    
    if not GDATA["recording"]:
        messagebox.showwarning("警告", "錄影未開始！")
        return
    # Hide fps
    GDATA["UI"]["fps_label"].set("")
    GDATA["recording"] = False
    ui_enable_disable(True)
    if GDATA["UI"]["record_system_sound"].get() == True:
        GDATA["THREAD"]["audio_system_thread"].join()
    if GDATA["UI"]["record_mic_sound"].get() == True:
        GDATA["THREAD"]["audio_mic_thread"].join()
    # 影片最後才結束
    # time.sleep(3);
    GDATA["THREAD"]["video_thread"].join()
    GDATA["THREAD"]["process_thread"].join()
    GDATA["UI"]["start_button"].config(state=tk.NORMAL)
    GDATA["UI"]["stop_button"].config(state=tk.DISABLED)
    messagebox.showinfo("提示", "錄影已停止")
    #time.sleep(3) # Wait 3sec
    merge_audio_video()

def find_device_by_name(keywords):
    devices = sd.query_devices()
    for idx, device in enumerate(devices):
        for keyword in keywords:
            if keyword in device["name"]:
                return idx, device["name"]
    return None, None  # 如果未找到匹配的設備，返回 None


def merge_audio_video():
    global GDATA
    
    # 此時才處理幀列表、變色、輸出影片
    # (cv2.VIDEOWRITER_PROP_HW_ACCELERATION, cv2.VIDEO_ACCELERATION_ANY
    
    #for frame in GDATA["frame_list"]:
    #    # 現在才處理幀，轉成 BGR 寫入影片
    #    # 最後影片完成再處理顏色 
    #    frame = np.array(frame)        
    #    frame = cv2.cvtColor(frame, cv2.COLOR_BGRA2BGR)
    #    GDATA["out"].write(frame)
    
    del GDATA["frame_list"]
    GDATA["frame_list"] = []
    #GDATA["out"].release()
    #del GDATA["out"]
    # 讀取錄製好的視頻    
    video_clip = VideoFileClip(GDATA["video_file"])
    
    # 進度條初始化
    total_frames = video_clip.reader.nframes
    #GDATA["UI"]["progress"] = tqdm(total=total_frames, desc="Processing video", unit="frame")
    # 更新進度條的函數
    def update_progress(get_frame, t):
        current_frame = int(t * GDATA["fps"])
        progress_percentage = (current_frame / total_frames) * 100        
        GDATA["UI"]["progress"]["value"] = progress_percentage        
        return get_frame(t)
    # 將進度條綁定到每一幀
    GDATA["UI"]["progress_label"].config(text="合併影像")
    processed_video_clip = video_clip.fl(update_progress, apply_to=['mask', 'video'])
    def run():
        # Logger From : https://stackoverflow.com/questions/69423410/moviepy-getting-progress-bar-values
        class MyBarLogger(ProgressBarLogger):

            def __init__(self):
                super().__init__()
                self.last_message = ''
                self.previous_percentage = 0  
                GDATA["UI"]["progress_label"].config(text="輸出影片")
            
            def callback(self, **changes):
                # Every time the logger message is updated, this function is called with
                # the `changes` dictionary of the form `parameter: new value`.
                for (parameter, value) in changes.items():
                    # print ('Parameter %s is now %s' % (parameter, value))
                    self.last_message = value
            
            def bars_callback(self, bar, attr, value,old_value=None):
                # Every time the logger progress is updated, this function is called        
                if 'Writing video' in self.last_message:
                    percentage = (value / self.bars[bar]['total']) * 100
                    GDATA["UI"]["progress"]["value"] = self.previous_percentage
                    if percentage > 0 and percentage < 100:
                        if int(percentage) != self.previous_percentage:
                            self.previous_percentage = int(percentage)
                            #print(self.previous_percentage)                            

        logger = MyBarLogger()
        tmp_merge_wav_file = GDATA["output_path"] + "\\" + str(int(time.time())) + "_merge.wav"
        if GDATA["UI"]["record_system_sound"].get() == True and GDATA["UI"]["record_mic_sound"].get() == True:
            # from: https://stackoverflow.com/questions/59665469/pyaudio-how-to-capture-microphone-and-system-sounds-in-a-single-stream
            # 同時有二個聲音，合併
            speakersound = AudioSegment.from_file(GDATA["audio_system_file"])
            
            micsound = AudioSegment.from_file(GDATA["audio_mic_file"])
            mixsound = speakersound.overlay(micsound)
            mixsound.export(tmp_merge_wav_file, format="wav")
            del speakersound        
            del mixsound
            final_audio_clip = AudioFileClip(tmp_merge_wav_file)
            # 將合併後的音訊剪輯添加到視訊剪輯中
            final_clip = processed_video_clip.set_audio(final_audio_clip)
            
            del final_audio_clip
            final_clip.write_videofile(GDATA["output_file"], codec="libx264", audio_codec="aac", logger=logger)       
                    
            del final_clip
        elif GDATA["UI"]["record_system_sound"].get() == True and GDATA["UI"]["record_mic_sound"].get() == False:
            # 只有系統聲
            final_audio_clip = AudioFileClip(GDATA["audio_system_file"])
            final_clip = processed_video_clip.set_audio(final_audio_clip)
            final_clip.write_videofile(GDATA["output_file"], codec="libx264", audio_codec="aac", logger=logger)
            
            del final_audio_clip
            del final_clip
        elif GDATA["UI"]["record_system_sound"].get() == False and GDATA["UI"]["record_mic_sound"].get() == True:
            # 只有麥克風
            final_audio_clip = AudioFileClip(GDATA["audio_mic_file"])
            final_clip = processed_video_clip.set_audio(final_audio_clip)
            final_clip.write_videofile(GDATA["output_file"], codec="libx264", audio_codec="aac", logger=logger)
            
            del final_audio_clip
            del final_clip
        else:
            # 無聲音
            video_clip.write_videofile(GDATA["output_file"], codec="libx264", logger=logger)
            del video_clip

        if os.path.isfile(GDATA["video_file"]):
            try:
                os.remove(GDATA["video_file"])
            except:
                pass
        if os.path.isfile(GDATA["audio_mic_file"]):
            try:
                os.remove(GDATA["audio_mic_file"])
            except:
                pass
        if os.path.isfile(GDATA["audio_system_file"]):
            try:
                os.remove(GDATA["audio_system_file"])
            except:
                pass
        if os.path.isfile(tmp_merge_wav_file):
            try:
                os.remove(tmp_merge_wav_file)
            except:
                pass
        GDATA["UI"]["progress_label"].config(text="轉檔完成")
        GDATA["UI"]["progress"]["value"] = 0
    GDATA["THREAD"]["run"] = threading.Thread(target=run)    
    GDATA["THREAD"]["run"].start()

def open_folder():
    global GDATA
    folder_path = os.path.dirname(os.path.abspath(GDATA["output_file"]))
    webbrowser.open(folder_path)

def on_message():
    global MESSAGE
    messagebox.showinfo("說明", MESSAGE)

def on_closing():
    global GDATA    
    if GDATA["recording"]:
        if messagebox.askokcancel("離開", "錄影正在進行，確定要離開嗎？"):
            stop_recording()
            root.destroy()
    else:
        root.destroy()


# 函數：鼠標按下時的位置
def win_start_move(event):
    root.x = event.x
    root.y = event.y


def win_stop_move(event):
    root.x = None
    root.y = None


def win_do_move(event):
    deltax = event.x - root.x
    deltay = event.y - root.y
    x = root.winfo_x() + deltax
    y = root.winfo_y() + deltay
    root.geometry(f"+{x}+{y}")


root = tk.Tk()

# 將 base64 字符串解碼為二進制數據
binary_data = base64.b64decode(icon_b64)

# 釋放 ram
icon_b64 = None

# 將二進制數據寫入文件
with open(GDATA["pwd"] + "\\tmp_icon.ico", "wb") as f:
    f.write(binary_data)
binary_data = None


# 設置窗口圖標
root.iconbitmap(GDATA["pwd"] + "\\tmp_icon.ico")
if os.path.isfile(GDATA["pwd"] + "\\tmp_icon.ico"):
    os.remove(GDATA["pwd"] + "\\tmp_icon.ico")

# 計算窗口位置
screen_width = root.winfo_screenwidth()
screen_height = root.winfo_screenheight()
window_width = 450  # 假設窗口寬度為 450
window_height = 140  # 假設窗口高度為  140

# 計算窗口位置: 右下角150px，距離底部30%
x = screen_width - window_width - 150
y = int(screen_height * 0.7)

# 設置窗口位置和大小
root.geometry(f"{window_width}x{window_height}+{x}+{y}")

# 設置窗口不可縮放
root.resizable(False, False)

root.title(f"我的桌面錄影 - V{GDATA["VERSION"]} By 羽山秋人(https://3wa.tw)")

# 使用Frame將按鈕排成一行
# 第一列
GDATA["UI"]["button_frame"] = tk.Frame(root)
GDATA["UI"]["button_frame"].pack(pady=10)

GDATA["UI"]["select_area_button"] = tk.Button(GDATA["UI"]["button_frame"], text="選擇錄影範圍", command=select_area)
GDATA["UI"]["select_area_button"].pack(side=tk.LEFT, padx=5)

GDATA["UI"]["start_button"] = tk.Button(GDATA["UI"]["button_frame"], text="開始錄影", command=start_recording)
GDATA["UI"]["start_button"].pack(side=tk.LEFT, padx=5)

GDATA["UI"]["stop_button"] = tk.Button(
    GDATA["UI"]["button_frame"], text="停止錄影", command=stop_recording, state=tk.DISABLED
)
GDATA["UI"]["stop_button"].pack(side=tk.LEFT, padx=5)

GDATA["UI"]["open_folder_button"] = tk.Button(GDATA["UI"]["button_frame"], text="打開錄影資料夾", command=open_folder)
GDATA["UI"]["open_folder_button"].pack(side=tk.LEFT, padx=5)

GDATA["UI"]["info_button"] = tk.Button(GDATA["UI"]["button_frame"], text="說明", command=on_message)
GDATA["UI"]["info_button"].pack(side=tk.LEFT, padx=5)

GDATA["UI"]["exit_button"] = tk.Button(GDATA["UI"]["button_frame"], text="離開程式", command=on_closing)
GDATA["UI"]["exit_button"].pack(side=tk.LEFT, padx=5)

# 第二列

GDATA["UI"]["checkbox_frame"] = tk.Frame(root)
GDATA["UI"]["checkbox_frame"].pack()

# 創建並佈局"截取滑鼠"，預設選中
GDATA["UI"]["record_mouse"] = tk.BooleanVar()
GDATA["UI"]["record_mouse"].set(True)  # 預設選擇
GDATA["UI"]["checkbox_mouse_cursor"] = tk.Checkbutton(
    GDATA["UI"]["checkbox_frame"], text="錄滑鼠指標", variable=GDATA["UI"]["record_mouse"]
)
GDATA["UI"]["checkbox_mouse_cursor"].pack(side=tk.LEFT, padx=5)

# 創建並佈局"錄系統聲音"的複選框，預設選擇
GDATA["UI"]["record_system_sound"] = tk.BooleanVar()
GDATA["UI"]["record_system_sound"].set(True)  # 預設選擇
GDATA["UI"]["checkbox_system_sound"] = tk.Checkbutton(
    GDATA["UI"]["checkbox_frame"], text="錄系統聲音", variable=GDATA["UI"]["record_system_sound"]
)
GDATA["UI"]["checkbox_system_sound"].pack(side=tk.LEFT, padx=5)

# 創建並佈局"錄麥克風"的複選框，預設不選中
GDATA["UI"]["record_mic_sound"] = tk.BooleanVar()
GDATA["UI"]["record_mic_sound"].set(False)  # 預設不選
GDATA["UI"]["checkbox_microphone"] = tk.Checkbutton(
    GDATA["UI"]["checkbox_frame"], text="錄麥克風", variable=GDATA["UI"]["record_mic_sound"]
)
GDATA["UI"]["checkbox_microphone"].pack(side=tk.LEFT, padx=5)

# 第三列
GDATA["UI"]["third_frame"] = tk.Frame(root)
GDATA["UI"]["third_frame"].pack()

# 創建並布局下拉選單
GDATA["UI"]["fps_txt_label"] = tk.Label(GDATA["UI"]["third_frame"], text="選擇 FPS：")
GDATA["UI"]["fps_txt_label"].pack(side=tk.LEFT, padx=5)

fps_options = [15, 20, 25, 27, 30, 60]
GDATA["UI"]["fps_selected"] = tk.IntVar()
GDATA["UI"]["fps_selected"].set(25)  # 預設 25 fps
GDATA["UI"]["fps_menu"] = tk.OptionMenu(GDATA["UI"]["third_frame"], GDATA["UI"]["fps_selected"], *fps_options)
GDATA["UI"]["fps_menu"].pack(side=tk.LEFT, padx=5)

# 畫質壓縮
GDATA["UI"]["compression_level_label"] = tk.Label(GDATA["UI"]["third_frame"], text="畫質壓縮(0不壓縮)：")
GDATA["UI"]["compression_level_label"].pack(side=tk.LEFT, padx=5)
compression_level_option = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
GDATA["UI"]["compression_level_selected"] = tk.IntVar()
GDATA["UI"]["compression_level_selected"].set(2)  # 預設 2 fps
GDATA["UI"]["compression_level_selected_menu"] = tk.OptionMenu(GDATA["UI"]["third_frame"], GDATA["UI"]["compression_level_selected"], *compression_level_option)
GDATA["UI"]["compression_level_selected_menu"].pack(side=tk.LEFT, padx=5)

# 顯示 fps 數值使用
GDATA["UI"]["fps_label"] = StringVar()
GDATA["UI"]["fps_display"] = Label(GDATA["UI"]["third_frame"], textvariable=GDATA["UI"]["fps_label"])
GDATA["UI"]["fps_display"].pack()

# 第四列
GDATA["UI"]["fouth_frame"] = tk.Frame(root)
GDATA["UI"]["fouth_frame"].pack()


GDATA["UI"]["progress_label"] = tk.Label(GDATA["UI"]["fouth_frame"], text="進度條：")
GDATA["UI"]["progress_label"].pack(side=tk.LEFT)

GDATA["UI"]["progress"] = ttk.Progressbar(GDATA["UI"]["fouth_frame"], orient="horizontal", length=300, mode="determinate")
GDATA["UI"]["progress"].pack() #pady=20



root.protocol("WM_DELETE_WINDOW", on_closing)



# 綁定標題欄的鼠標按下事件
root.bind("<ButtonPress-1>", win_start_move)
root.bind("<ButtonRelease-1>", win_stop_move)
root.bind("<B1-Motion>", win_do_move)


# 使用 root.after 來降低 FPS 顯示的更新頻率
def update_fps_label():
    #global GDATA
    if GDATA["recording"]:
        try:
            #GDATA["UI"]["fps_label"].config(f"FPS: {calculate_current_fps():.2f}")
            GDATA["UI"]["fps_label"].set(f"FPS: {calculate_current_fps():.2f}")
            root.after(1000, update_fps_label)  # 每秒更新一次
        except:
            pass                

# 計算當前 FPS 的輔助函數
def calculate_current_fps():
    #global GDATA
    elapsed_time = time.time() - GDATA["start_time"]
    current_fps = GDATA["frame_count"] / elapsed_time if elapsed_time > 0 else 0
    GDATA["frame_count"] = 0
    GDATA["start_time"] = time.time()
    return current_fps

root.mainloop()